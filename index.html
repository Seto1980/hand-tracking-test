<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Rehab Counter V3</title>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
<style>
    body { 
        background-color: #1e1e1e; color: #fff; margin: 0; overflow: hidden; font-family: sans-serif; 
        display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh;
    }

    /* --- è¨­å®šç”»é¢ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ --- */
    #settings-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(30, 30, 30, 0.95); z-index: 100;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 20px; box-sizing: border-box;
    }
    .setting-group { margin-bottom: 20px; width: 100%; max-width: 400px; }
    .setting-title { font-size: 1.2rem; color: #aaa; margin-bottom: 10px; text-align: center; }
    .btn-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    .select-btn {
        padding: 10px 20px; border: 2px solid #555; background: #333; color: #fff;
        border-radius: 20px; cursor: pointer; font-size: 1rem; flex: 1; text-align: center;
    }
    .select-btn.active { background: #007bff; border-color: #007bff; }
    
    input[type="number"] { padding: 10px; border-radius: 10px; border: none; width: 80px; text-align: center; font-size: 1.2rem; }
    
    #start-app-btn {
        padding: 15px 50px; background: #28a745; color: white; border: none;
        border-radius: 30px; font-size: 1.5rem; font-weight: bold; margin-top: 20px; cursor: pointer;
    }

    /* --- ãƒ¡ã‚¤ãƒ³ç”»é¢ --- */
    #info-panel {
        position: absolute; top: 10px; left: 0; width: 100%; z-index: 20;
        background: rgba(0, 0, 0, 0.6); padding: 10px 0;
        display: flex; justify-content: space-around; align-items: center;
    }
    .info-item { text-align: center; }
    .info-label { font-size: 0.8rem; color: #ccc; }
    .info-value { font-size: 1.5rem; font-weight: bold; }
    #status-text { color: #4caf50; min-width: 100px; }

    .container { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: #000; }
    video, canvas { position: absolute; width: 100%; height: 100%; object-fit: cover; }
    
    /* ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ */
    #reset-btn {
        position: absolute; bottom: 20px; right: 20px; z-index: 30;
        padding: 10px 20px; background: #555; color: white; border: none; border-radius: 5px;
    }
</style>
</head>
<body>

<div id="settings-overlay">
    <h1 style="margin-bottom:30px;">ãƒªãƒãƒ“ãƒªè¨­å®š</h1>
    
    <div class="setting-group">
        <div class="setting-title">1. å‹•ãã®ãƒ‘ã‚¿ãƒ¼ãƒ³</div>
        <div class="btn-group" id="mode-group">
            <div class="select-btn active" data-mode="GRASP">âœŠâœ‹<br>æ¡ã‚‹ãƒ»é›¢ã™</div>
            <div class="select-btn" data-mode="FINGER">ğŸ‘ğŸ–<br>æŒ‡æŠ˜ã‚Š</div>
            <div class="select-btn" data-mode="JANKEN">âœŠâœŒğŸ–<br>ã‚¸ãƒ£ãƒ³ã‚±ãƒ³</div>
        </div>
    </div>

    <div class="setting-group">
        <div class="setting-title">2. ç›®æ¨™å›æ•°</div>
        <div class="btn-group" id="count-group">
            <div class="select-btn" data-count="10">10å›</div>
            <div class="select-btn" data-count="50">50å›</div>
            <div class="select-btn" data-count="100">100å›</div>
            <input type="number" id="custom-count" placeholder="è‡ªç”±" min="1">
        </div>
    </div>

    <button id="start-app-btn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<div id="info-panel">
    <div class="info-item">
        <div class="info-label">ç¾åœ¨</div>
        <div class="info-value" id="current-count">0</div>
    </div>
    <div class="info-item">
        <div class="info-value" id="status-text">å¾…æ©Ÿä¸­</div>
    </div>
    <div class="info-item">
        <div class="info-label">ç›®æ¨™</div>
        <div class="info-value" id="target-count-display">--</div>
    </div>
</div>

<div class="container">
    <video id="inputVideo" playsinline></video>
    <canvas id="outputCanvas"></canvas>
</div>
<button id="reset-btn">è¨­å®šã«æˆ»ã‚‹</button>

<script>
    // --- å¤‰æ•°å®šç¾© ---
    let targetCount = 10;
    let currentCount = 0;
    let mode = 'GRASP'; // GRASP, FINGER, JANKEN
    let isProcessing = false;
    let stepState = 0; // å„ãƒ¢ãƒ¼ãƒ‰ã®é€²è¡ŒçŠ¶æ³ç®¡ç†
    
    // éŸ³å£°åˆæˆ
    const synth = window.speechSynthesis;
    function speak(text) {
        if (synth.speaking) return;
        const ut = new SpeechSynthesisUtterance(text);
        ut.lang = 'ja-JP';
        synth.speak(ut);
    }

    // --- UIæ“ä½œ ---
    const settingsOverlay = document.getElementById('settings-overlay');
    const modeBtns = document.querySelectorAll('#mode-group .select-btn');
    const countBtns = document.querySelectorAll('#count-group .select-btn');
    const customCountInput = document.getElementById('custom-count');
    const currentCountDisplay = document.getElementById('current-count');
    const targetCountDisplay = document.getElementById('target-count-display');
    const statusText = document.getElementById('status-text');

    // ãƒ¢ãƒ¼ãƒ‰é¸æŠ
    modeBtns.forEach(btn => {
        btn.onclick = () => {
            modeBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            mode = btn.dataset.mode;
        };
    });

    // å›æ•°é¸æŠ
    countBtns.forEach(btn => {
        btn.onclick = () => {
            countBtns.forEach(b => b.classList.remove('active'));
            customCountInput.value = ''; // è‡ªç”±å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
            btn.classList.add('active');
            targetCount = parseInt(btn.dataset.count);
        };
    });
    customCountInput.oninput = () => {
        countBtns.forEach(b => b.classList.remove('active'));
        targetCount = parseInt(customCountInput.value) || 10;
    };

    // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
    document.getElementById('start-app-btn').onclick = () => {
        settingsOverlay.style.display = 'none';
        currentCount = 0;
        stepState = 0;
        currentCountDisplay.innerText = 0;
        targetCountDisplay.innerText = targetCount;
        startCamera();
        
        let modeName = "";
        if(mode === 'GRASP') modeName = "æ¡ã£ã¦ã€é›¢ã™é‹å‹•ã€‚";
        if(mode === 'FINGER') modeName = "æŒ‡æŠ˜ã‚Šæ•°ãˆé‹å‹•ã€‚ã‚°ãƒ¼ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚";
        if(mode === 'JANKEN') modeName = "ã‚¸ãƒ£ãƒ³ã‚±ãƒ³é‹å‹•ã€‚ã‚°ãƒ¼ã€ãƒãƒ§ã‚­ã€ãƒ‘ãƒ¼ã®é †ã§ã™ã€‚";
        speak(modeName + "ç›®æ¨™ã€" + targetCount + "å›ã€ã‚¹ã‚¿ãƒ¼ãƒˆï¼");
    };

    // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
    document.getElementById('reset-btn').onclick = () => {
        location.reload();
    };

    // --- MediaPipe è¨­å®š ---
    const videoElement = document.getElementById('inputVideo');
    const canvasElement = document.getElementById('outputCanvas');
    const canvasCtx = canvasElement.getContext('2d');

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

    hands.onResults(onResults);

    // --- è§£æãƒ­ã‚¸ãƒƒã‚¯ ---
    function onResults(results) {
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
        
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
            drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1});

            // ç›®æ¨™é”æˆãªã‚‰ä½•ã‚‚ã—ãªã„
            if(currentCount >= targetCount) {
                if(statusText.innerText !== "é”æˆï¼") {
                    statusText.innerText = "é”æˆï¼";
                    statusText.style.color = "gold";
                    speak("ç›®æ¨™é”æˆã§ã™ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼");
                }
                canvasCtx.restore();
                return;
            }

            // ãƒ¢ãƒ¼ãƒ‰åˆ¥å‡¦ç†
            if (mode === 'GRASP') processGrasp(landmarks);
            else if (mode === 'FINGER') processFingerCount(landmarks);
            else if (mode === 'JANKEN') processJanken(landmarks);
        }
        canvasCtx.restore();
    }

    // --- 1. æ¡ã‚‹ãƒ»é›¢ã™ãƒ¢ãƒ¼ãƒ‰ ---
    // stepState: 0=æ¡ã‚Šå¾…ã¡, 1=é–‹ãå¾…ã¡
    function processGrasp(landmarks) {
        const fingers = countExtendedFingers(landmarks);
        // ã‚°ãƒ¼åˆ¤å®š(0-1æœ¬)
        if (fingers <= 1) {
            if (stepState === 0) {
                stepState = 1; // æ¡ã£ãŸã“ã¨ã‚’è¨˜éŒ²
                statusText.innerText = "é–‹ã„ã¦ï¼";
            }
        } 
        // ãƒ‘ãƒ¼åˆ¤å®š(4-5æœ¬)
        else if (fingers >= 4) {
            if (stepState === 1) { // æ¡ã£ãŸçŠ¶æ…‹ã‹ã‚‰é–‹ã„ãŸå ´åˆ
                incrementCount();
                stepState = 0; // æ¬¡ã®æ¡ã‚Šå¾…ã¡ã¸
                statusText.innerText = "æ¡ã£ã¦";
            }
        }
    }

    // --- 2. æŒ‡æŠ˜ã‚Šãƒ¢ãƒ¼ãƒ‰ (1ã‹ã‚‰5ã¾ã§æ•°ãˆã‚‹) ---
    // stepState: 0=ã‚°ãƒ¼(é–‹å§‹), 1=è¦ªæŒ‡OK, 2=äººå·®ã—æŒ‡OK... 5=å…¨éƒ¨OK
    function processFingerCount(landmarks) {
        const extended = getExtendedFingersArray(landmarks); // [è¦ª, äºº, ä¸­, è–¬, å°] ã®true/false
        const count = extended.filter(Boolean).length;

        // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆï¼ˆã‚°ãƒ¼ã«æˆ»ã£ãŸã‚‰æœ€åˆã‹ã‚‰ï¼‰
        if (count === 0 && stepState === 5) {
            stepState = 0; 
            statusText.innerText = "è¦ªæŒ‡ã‹ã‚‰";
            return;
        }

        // é †ç•ªãƒã‚§ãƒƒã‚¯
        // Step 1: è¦ªæŒ‡ã ã‘ (Thumb)
        if (stepState === 0 && count === 1 && extended[0]) {
            speak("1"); stepState = 1; statusText.innerText = "æ¬¡ã¯äººå·®ã—æŒ‡";
        }
        // Step 2: è¦ª+äºº (Thumb + Index)
        else if (stepState === 1 && count === 2 && extended[1]) {
            speak("2"); stepState = 2;
        }
        // Step 3: +ä¸­ (Middle)
        else if (stepState === 2 && count === 3 && extended[2]) {
            speak("3"); stepState = 3;
        }
        // Step 4: +è–¬ (Ring)
        else if (stepState === 3 && count === 4 && extended[3]) {
            speak("4"); stepState = 4; statusText.innerText = "æœ€å¾Œã¯å°æŒ‡";
        }
        // Step 5: +å° (Pinky) -> å®Œäº†
        else if (stepState === 4 && count === 5 && extended[4]) {
            speak("5"); 
            incrementCount(); // 1ã‚»ãƒƒãƒˆå®Œäº†
            stepState = 5; // å®Œäº†çŠ¶æ…‹
            statusText.innerText = "ã‚°ãƒ¼ã«æˆ»ã—ã¦";
        }
    }

    // --- 3. ã‚¸ãƒ£ãƒ³ã‚±ãƒ³ãƒ¢ãƒ¼ãƒ‰ (ã‚°ãƒ¼â†’ãƒãƒ§ã‚­â†’ãƒ‘ãƒ¼) ---
    // stepState: 0=ã‚°ãƒ¼å¾…ã¡, 1=ãƒãƒ§ã‚­å¾…ã¡, 2=ãƒ‘ãƒ¼å¾…ã¡, 3=å®Œäº†å¾…æ©Ÿ
    function processJanken(landmarks) {
        const shape = detectJankenShape(landmarks);
        
        // ã‚°ãƒ¼ (Gu)
        if (stepState === 0 && shape === 'ROCK') {
            speak("ã‚°ãƒ¼");
            stepState = 1; statusText.innerText = "æ¬¡ã¯ãƒãƒ§ã‚­";
        }
        // ãƒãƒ§ã‚­ (Choki)
        else if (stepState === 1 && shape === 'SCISSORS') {
            speak("ãƒãƒ§ã‚­");
            stepState = 2; statusText.innerText = "æœ€å¾Œã¯ãƒ‘ãƒ¼";
        }
        // ãƒ‘ãƒ¼ (Pa)
        else if (stepState === 2 && shape === 'PAPER') {
            speak("ãƒ‘ãƒ¼");
            incrementCount(); // 1ã‚»ãƒƒãƒˆå®Œäº†
            stepState = 3; statusText.innerText = "ã‚°ãƒ¼ã«æˆ»ã—ã¦";
        }
        // ãƒªã‚»ãƒƒãƒˆ (ã¾ãŸã‚°ãƒ¼ã‚’å‡ºã—ãŸã‚‰æ¬¡ã¸)
        else if (stepState === 3 && shape === 'ROCK') {
             // ã™ãã«åå¿œã›ãšã€ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆæ‰±ã„ã«ã™ã‚‹ãªã‚‰ã“ã“
             stepState = 0;
             // ç¶šã‘ã¦ã‚«ã‚¦ãƒ³ãƒˆã—ãŸã„ãªã‚‰ã“ã“ã‚’0ã«ã—ã¦éŸ³å£°ã‚’å‡ºã™
             speak("ã‚°ãƒ¼");
             stepState = 1; statusText.innerText = "æ¬¡ã¯ãƒãƒ§ã‚­";
        }
    }

    // --- å…±é€šé–¢æ•° ---
    function incrementCount() {
        currentCount++;
        currentCountDisplay.innerText = currentCount;
        // æŒ‡æŠ˜ã‚Šã¨ã‚¸ãƒ£ãƒ³ã‚±ãƒ³ã®å ´åˆã¯ã€Œ1å›ã€ã¨ã‹ã€Œ1ã‚»ãƒƒãƒˆã€ã¨è¨€ã†
        if (mode !== 'GRASP') {
            speak(currentCount + "ã‚»ãƒƒãƒˆå®Œäº†");
        } else {
            speak(currentCount + "å›");
        }
    }

    // æŒ‡ãŒä¼¸ã³ã¦ã„ã‚‹ã‹åˆ¤å®šã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function getExtendedFingersArray(landmarks) {
        // 0:è¦ª, 1:äºº, 2:ä¸­, 3:è–¬, 4:å°
        const fingerTips = [4, 8, 12, 16, 20];
        const fingerPips = [2, 6, 10, 14, 18]; // è¦ªæŒ‡ã¯MCP(2)ã€ä»–ã¯PIP
        
        const extended = [false, false, false, false, false];

        // è¦ªæŒ‡åˆ¤å®š (Xåº§æ¨™ã®å·®åˆ†ã§ç°¡æ˜“åˆ¤å®šï¼šå³æ‰‹ã‚’æƒ³å®šã—ã¦å·¦ã«ã‚ã‚‹ã‹)
        // â€»æ±ç”¨æ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã€æ‰‹é¦–(0)ã¨ãã®ä»–ã®ä½ç½®é–¢ä¿‚ã§è¦‹ã‚‹ã®ãŒãƒ™ã‚¿ãƒ¼ã§ã™ãŒã€ç°¡æ˜“çš„ã«
        // è¦ªæŒ‡ã¯ã€ŒæŒ‡å…ˆã€ã¨ã€Œå°æŒ‡ã®ä»˜ã‘æ ¹(17)ã€ã®è·é›¢ vs ã€Œè¦ªæŒ‡ä»˜ã‘æ ¹(2)ã€ã¨ã€Œ17ã€ã®è·é›¢ã§æ¯”è¼ƒ
        const wrist = landmarks[0];
        const thumbTip = landmarks[4];
        const pinkyBase = landmarks[17];
        
        // è¦ªæŒ‡ãŒé–‹ã„ã¦ã„ã‚‹ã‹ï¼ˆå°æŒ‡ã®ä»˜ã‘æ ¹ã‹ã‚‰é ã„ã‹ï¼‰
        const distThumbTip = dist(thumbTip, pinkyBase);
        const distThumbBase = dist(landmarks[2], pinkyBase);
        extended[0] = distThumbTip > distThumbBase * 1.2;

        // ä»–ã®4æœ¬ (æŒ‡å…ˆãŒé–¢ç¯€ã‚ˆã‚Šä¸Šã«ã‚ã‚‹ã‹ã€‚Yåº§æ¨™ã¯ä¸ŠãŒ0ãªã®ã§ Tip < Pip)
        for (let i = 1; i <= 4; i++) {
            extended[i] = landmarks[fingerTips[i]].y < landmarks[fingerPips[i]].y;
        }
        return extended;
    }

    function countExtendedFingers(landmarks) {
        const arr = getExtendedFingersArray(landmarks);
        return arr.filter(Boolean).length;
    }

    function detectJankenShape(landmarks) {
        const extended = getExtendedFingersArray(landmarks);
        const count = extended.filter(Boolean).length;
        // è¦ªæŒ‡ã¯ã‚¸ãƒ£ãƒ³ã‚±ãƒ³ã®å½¢ã«ã‚ˆã£ã¦å¾®å¦™ãªã®ã§ã€è¦ªæŒ‡ä»¥å¤–ã®4æœ¬ã‚’é‡è¦–
        const index = extended[1];
        const middle = extended[2];
        const ring = extended[3];
        const pinky = extended[4];

        if (count <= 1) return 'ROCK'; // ã»ã¼é–‰ã˜ã¦ã‚‹
        if (count >= 4) return 'PAPER'; // ã»ã¼é–‹ã„ã¦ã‚‹
        if (index && middle && !ring && !pinky) return 'SCISSORS'; // ãƒãƒ§ã‚­
        return 'UNKNOWN';
    }

    function dist(p1, p2) {
        return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
    }

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: 1280, height: 720 } 
            });
            videoElement.srcObject = stream;
            videoElement.play();
            videoElement.onloadedmetadata = () => {
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                processVideo();
            };
        } catch (err) { alert("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: " + err.name); }
    }

    async function processVideo() {
        await hands.send({image: videoElement});
        requestAnimationFrame(processVideo);
    }
</script>
</body>
</html>
