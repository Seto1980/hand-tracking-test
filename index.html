<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Rehab Counter V6</title>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
<style>
    body { 
        background-color: #1e1e1e; color: #fff; margin: 0; overflow: hidden; font-family: sans-serif; 
        display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh;
    }

    /* --- è¨­å®šç”»é¢ --- */
    #settings-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(30, 30, 30, 0.98); z-index: 100;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 20px; box-sizing: border-box;
    }
    .setting-group { margin-bottom: 20px; width: 100%; max-width: 400px; }
    .setting-title { font-size: 1.2rem; color: #aaa; margin-bottom: 10px; text-align: center; }
    .btn-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    .select-btn {
        padding: 10px 15px; border: 2px solid #555; background: #333; color: #fff;
        border-radius: 20px; cursor: pointer; font-size: 1rem; flex: 1; text-align: center; min-width: 80px;
    }
    .select-btn.active { background: #007bff; border-color: #007bff; }
    input[type="number"] { padding: 10px; border-radius: 10px; border: none; width: 80px; text-align: center; font-size: 1.2rem; }
    #start-app-btn {
        padding: 15px 50px; background: #28a745; color: white; border: none;
        border-radius: 30px; font-size: 1.5rem; font-weight: bold; margin-top: 20px; cursor: pointer;
    }

    /* --- ãƒ¡ã‚¤ãƒ³ç”»é¢ --- */
    #info-panel {
        position: absolute; top: 0; left: 0; width: 100%; z-index: 20;
        background: rgba(0, 0, 0, 0.7); padding: 10px 0;
        display: flex; flex-direction: column; align-items: center;
    }
    .info-row { display: flex; justify-content: space-around; width: 100%; align-items: center; }
    .info-item { text-align: center; }
    .info-label { font-size: 0.7rem; color: #ccc; }
    .info-value { font-size: 1.5rem; font-weight: bold; }
    #status-text { color: #4caf50; font-size: 1.2rem; min-width: 100px; }
    
    /* æŒ‡èªè­˜çŠ¶æ³ã®å¯è¦–åŒ– */
    #finger-visualizer {
        font-family: monospace; font-size: 1.5rem; color: #00FF00; margin-top: 10px; letter-spacing: 5px; font-weight: bold;
    }
    #finger-labels {
        font-size: 0.7rem; color: #aaa; margin-top: 2px; letter-spacing: 8px;
    }

    /* é”æˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    #celebration-msg {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        font-size: 3rem; color: gold; font-weight: bold; text-shadow: 0 0 10px red;
        display: none; z-index: 50; text-align: center; width: 100%;
    }

    .container { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: #000; }
    video, canvas { position: absolute; width: 100%; height: 100%; object-fit: cover; }
    #reset-btn {
        position: absolute; bottom: 20px; right: 20px; z-index: 30;
        padding: 10px 20px; background: #555; color: white; border: none; border-radius: 5px;
    }
</style>
</head>
<body>

<div id="settings-overlay">
    <h1 style="margin-bottom:20px;">ãƒªãƒãƒ“ãƒªè¨­å®š V6</h1>
    
    <div class="setting-group">
        <div class="setting-title">1. å‹•ãã®ãƒ‘ã‚¿ãƒ¼ãƒ³</div>
        <div class="btn-group" id="mode-group">
            <div class="select-btn active" data-mode="GRASP">âœŠâœ‹<br>æ¡ã‚‹</div>
            <div class="select-btn" data-mode="FINGER">ğŸ‘ğŸ–<br>æŒ‡æŠ˜ã‚Š<br>(é †ä¸åŒ)</div>
            <div class="select-btn" data-mode="JANKEN">âœŠâœŒğŸ–<br>ã‚¸ãƒ£ãƒ³ã‚±ãƒ³</div>
        </div>
    </div>

    <div class="setting-group">
        <div class="setting-title">2. ç›®æ¨™å›æ•°</div>
        <div class="btn-group" id="count-group">
            <div class="select-btn" data-count="10">10å›</div>
            <div class="select-btn" data-count="50">50å›</div>
            <div class="select-btn" data-count="100">100å›</div>
            <input type="number" id="custom-count" placeholder="è‡ªç”±" min="1">
        </div>
    </div>
    <button id="start-app-btn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<div id="celebration-msg">ã‚¹ã‚´ã‚¤ã§ã™ã­ï¼<br>ç›®æ¨™é”æˆï¼</div>

<div id="info-panel">
    <div class="info-row">
        <div class="info-item">
            <div class="info-label">ç¾åœ¨</div>
            <div class="info-value" id="current-count">0</div>
        </div>
        <div class="info-item">
            <div class="info-value" id="status-text">èµ·å‹•ä¸­...</div>
        </div>
        <div class="info-item">
            <div class="info-label">ç›®æ¨™</div>
            <div class="info-value" id="target-count-display">--</div>
        </div>
    </div>
    <div id="finger-visualizer">ãƒ» ãƒ» ãƒ» ãƒ» ãƒ»</div>
    <div id="finger-labels">è¦ª äºº ä¸­ è–¬ å°</div>
</div>

<div class="container">
    <video id="inputVideo" playsinline></video>
    <canvas id="outputCanvas"></canvas>
</div>
<button id="reset-btn">è¨­å®šã«æˆ»ã‚‹</button>

<script>
    // å¤‰æ•°
    let targetCount = 10;
    let currentCount = 0;
    let mode = 'GRASP'; 
    let stepState = 0; 
    let isCelebrated = false;
    
    // æŒ‡æŠ˜ã‚Šãƒ¢ãƒ¼ãƒ‰ç”¨ã®å±¥æ­´ [è¦ª, äºº, ä¸­, è–¬, å°]
    let fingerLatch = [false, false, false, false, false];

    // éŸ³å£°åˆæˆ
    const synth = window.speechSynthesis;
    function speak(text, force = false) {
        if (!force && synth.speaking) return;
        if (force) synth.cancel();
        const ut = new SpeechSynthesisUtterance(text);
        ut.lang = 'ja-JP';
        synth.speak(ut);
    }

    // UIå‚ç…§
    const settingsOverlay = document.getElementById('settings-overlay');
    const modeBtns = document.querySelectorAll('#mode-group .select-btn');
    const countBtns = document.querySelectorAll('#count-group .select-btn');
    const customCountInput = document.getElementById('custom-count');
    const currentCountDisplay = document.getElementById('current-count');
    const targetCountDisplay = document.getElementById('target-count-display');
    const statusText = document.getElementById('status-text');
    const fingerVisualizer = document.getElementById('finger-visualizer');
    const celebrationMsg = document.getElementById('celebration-msg');

    // è¨­å®šç”»é¢ãƒ­ã‚¸ãƒƒã‚¯
    modeBtns.forEach(btn => {
        btn.onclick = () => {
            modeBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            mode = btn.dataset.mode;
        };
    });
    countBtns.forEach(btn => {
        btn.onclick = () => {
            countBtns.forEach(b => b.classList.remove('active'));
            customCountInput.value = '';
            btn.classList.add('active');
            targetCount = parseInt(btn.dataset.count);
        };
    });
    customCountInput.oninput = () => {
        countBtns.forEach(b => b.classList.remove('active'));
        targetCount = parseInt(customCountInput.value) || 10;
    };

    // ã‚¹ã‚¿ãƒ¼ãƒˆ
    document.getElementById('start-app-btn').onclick = () => {
        settingsOverlay.style.display = 'none';
        currentCount = 0;
        stepState = 0;
        isCelebrated = false;
        fingerLatch = [false, false, false, false, false];
        updateVisualizer([false,false,false,false,false]);
        
        celebrationMsg.style.display = 'none';
        currentCountDisplay.innerText = 0;
        targetCountDisplay.innerText = targetCount;
        statusText.innerText = "æ‰‹ã‚’æ˜ ã—ã¦ã­";
        
        startCamera();
        
        let modeName = "";
        if(mode === 'GRASP') modeName = "æ¡ã£ã¦ã€é›¢ã™é‹å‹•ã€‚";
        if(mode === 'FINGER') modeName = "æŒ‡æŠ˜ã‚Šã€‚ã™ã¹ã¦ã®æŒ‡ã‚’ä¸€åº¦é–‹ã„ã¦ãã ã•ã„ã€‚";
        if(mode === 'JANKEN') modeName = "ã‚¸ãƒ£ãƒ³ã‚±ãƒ³ã€‚ã‚°ãƒ¼ã€ãƒãƒ§ã‚­ã€ãƒ‘ãƒ¼ã®é †ã§ã™ã€‚";
        speak(modeName + "ã‚¹ã‚¿ãƒ¼ãƒˆï¼", true);
    };
    document.getElementById('reset-btn').onclick = () => location.reload();

    // MediaPipe
    const videoElement = document.getElementById('inputVideo');
    const canvasElement = document.getElementById('outputCanvas');
    const canvasCtx = canvasElement.getContext('2d');
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    hands.onResults(onResults);

    function onResults(results) {
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
        
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
            drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1});

            if(currentCount >= targetCount) {
                if(!isCelebrated) {
                    isCelebrated = true;
                    statusText.innerText = "é”æˆï¼";
                    celebrationMsg.style.display = "block";
                    speak("ã‚¹ã‚´ã‚¤ã§ã™ã­ï¼ç›®æ¨™é”æˆã§ã™ï¼", true);
                }
                canvasCtx.restore();
                return;
            }

            // æŒ‡ã®çŠ¶æ…‹åˆ¤å®šï¼ˆé«˜æ„Ÿåº¦ç‰ˆï¼‰
            const extended = getExtendedFingersV6(landmarks);

            // ãƒ¢ãƒ¼ãƒ‰åˆ¥å‡¦ç†
            if (mode === 'FINGER') {
                // æŒ‡æŠ˜ã‚Šãƒ¢ãƒ¼ãƒ‰ï¼šå±¥æ­´ã‚’è“„ç©ã—ã¦è¡¨ç¤º
                processFingerAccumulate(extended);
            } else {
                // æ¡ã‚‹ãƒ»ã‚¸ãƒ£ãƒ³ã‚±ãƒ³ï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
                updateVisualizer(extended); 
                
                if (mode === 'GRASP') processGrasp(extended);
                else if (mode === 'JANKEN') processJanken(extended);
            }
        } 
        canvasCtx.restore();
    }

    // --- UIæ›´æ–° ---
    function updateVisualizer(extended) {
        // é…åˆ—ã‚’å—ã‘å–ã£ã¦ ã€‡ / ãƒ» ã‚’è¡¨ç¤º
        const marks = extended.map(isOn => isOn ? "ã€‡" : "ãƒ»").join(" ");
        fingerVisualizer.innerText = marks;
    }

    // --- åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---

    // 1. æŒ‡æŠ˜ã‚Šï¼ˆè“„ç©å‹ï¼‰
    function processFingerAccumulate(extended) {
        // ãƒªã‚»ãƒƒãƒˆå¾…ã¡ (5æœ¬é”æˆå¾Œã€ã‚°ãƒ¼ã«æˆ»ã‚‹ã¾ã§)
        if (stepState === 99) {
            const count = extended.filter(Boolean).length;
            updateVisualizer(fingerLatch); // é”æˆæ™‚ã®çŠ¶æ…‹(å…¨éƒ¨ã€‡)ã‚’ç¶­æŒ
            if (count <= 1) { // ã‚°ãƒ¼ã«æˆ»ã£ãŸ
                stepState = 0;
                fingerLatch = [false, false, false, false, false];
                updateVisualizer(fingerLatch);
                statusText.innerText = "å¥½ããªæŒ‡ã‹ã‚‰";
                speak("æ¬¡ã¸");
            }
            return;
        }

        // è¨ˆæ¸¬ä¸­
        let changed = false;
        for(let i=0; i<5; i++) {
            if (extended[i] && !fingerLatch[i]) {
                fingerLatch[i] = true;
                changed = true;
            }
        }
        
        // å¸¸ã«ç¾åœ¨ã®è“„ç©çŠ¶æ³ã‚’è¡¨ç¤º
        updateVisualizer(fingerLatch);

        const doneCount = fingerLatch.filter(Boolean).length;
        if (doneCount === 0) {
             statusText.innerText = "æŒ‡ã‚’åºƒã’ã¦";
        } else if (doneCount < 5) {
             statusText.innerText = "ã‚ã¨ " + (5 - doneCount) + " æœ¬";
        } else {
            // 5æœ¬å®Œäº†
            incrementCount();
            stepState = 99; 
            statusText.innerText = "ã‚°ãƒ¼ã«æˆ»ã—ã¦";
            speak("ã‚»ãƒƒãƒˆå®Œäº†ï¼ã‚°ãƒ¼ã«æˆ»ã—ã¦ãã ã•ã„");
        }
    }

    // 2. æ¡ã‚‹ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
    function processGrasp(extended) {
        const count = extended.filter(Boolean).length;
        if (count <= 1) {
            if (stepState === 0) { stepState = 1; statusText.innerText = "é–‹ã„ã¦ï¼"; }
        } else if (count >= 4) {
            if (stepState === 1) { incrementCount(); stepState = 0; statusText.innerText = "æ¡ã£ã¦"; }
        }
    }

    // 3. ã‚¸ãƒ£ãƒ³ã‚±ãƒ³ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
    function processJanken(extended) {
        const count = extended.filter(Boolean).length;
        let shape = 'UNKNOWN';
        if (count <= 1) shape = 'ROCK';
        else if (count >= 4) shape = 'PAPER';
        else if (extended[1] && extended[2] && !extended[3] && !extended[4]) shape = 'SCISSORS';

        if (stepState === 0 && shape === 'ROCK') {
            speak("ã‚°ãƒ¼"); stepState = 1; statusText.innerText = "æ¬¡ã¯ãƒãƒ§ã‚­";
        } else if (stepState === 1 && shape === 'SCISSORS') {
            speak("ãƒãƒ§ã‚­"); stepState = 2; statusText.innerText = "æœ€å¾Œã¯ãƒ‘ãƒ¼";
        } else if (stepState === 2 && shape === 'PAPER') {
            speak("ãƒ‘ãƒ¼"); incrementCount(); stepState = 3; statusText.innerText = "ã‚°ãƒ¼ã«æˆ»ã—ã¦";
        } else if (stepState === 3 && shape === 'ROCK') {
             stepState = 0; speak("ã‚°ãƒ¼"); stepState = 1; statusText.innerText = "æ¬¡ã¯ãƒãƒ§ã‚­";
        }
    }

    function incrementCount() {
        currentCount++;
        currentCountDisplay.innerText = currentCount;
        if (mode === 'GRASP') speak(currentCount + "å›");
        else speak(currentCount + "ã‚»ãƒƒãƒˆå®Œäº†");
    }

    // â˜…é‡è¦ï¼šæŒ‡ã®çŠ¶æ…‹åˆ¤å®š V6 (è·é›¢ãƒ™ãƒ¼ã‚¹ãƒ»é«˜æ„Ÿåº¦)
    function getExtendedFingersV6(landmarks) {
        const extended = [false, false, false, false, false];
        const wrist = landmarks[0];
        
        // æŒ‡å…ˆã¨ä»˜ã‘æ ¹(PIP/MCP)ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        // 0:è¦ª, 1:äºº, 2:ä¸­, 3:è–¬, 4:å°
        // è¦ªæŒ‡ã¯ Tip(4) vs IP(3) ã§ã¯ãªãã€Tip(4) vs IndexMCP(5) ã®è·é›¢ãªã©ã‚’è¤‡åˆçš„ã«è¦‹ã‚‹ã®ãŒä¸€ç•ªå®‰å®šã™ã‚‹
        // ã—ã‹ã—ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã‹ã¤å¼·åŠ›ãªã€Œæ‰‹é¦–ã‹ã‚‰ã®è·é›¢ã€ã‚’æ¡ç”¨ã—ã¾ã™ã€‚
        
        // è¦ªæŒ‡ (Thumb): Tip(4) vs MCP(2)
        // äººå·® (Index): Tip(8) vs PIP(6)
        // ...
        const fingerTips = [4, 8, 12, 16, 20];
        const fingerPips = [2, 6, 10, 14, 18]; // è¦ªæŒ‡ã¯MCP(2), ä»–ã¯PIP

        for (let i = 0; i < 5; i++) {
            const tip = landmarks[fingerTips[i]];
            const pip = landmarks[fingerPips[i]];

            // æ‰‹é¦–(0)ã‹ã‚‰ã®è·é›¢ã‚’è¨ˆç®—
            const distTip = Math.hypot(tip.x - wrist.x, tip.y - wrist.y);
            const distPip = Math.hypot(pip.x - wrist.x, pip.y - wrist.y);

            if (i === 0) {
                // ã€è¦ªæŒ‡ã®ç‰¹ä¾‹åˆ¤å®šã€‘
                // è¦ªæŒ‡ã¯ã€Œæ‰‹é¦–ã‹ã‚‰ã®è·é›¢ã€ã ã‘ã ã¨ã€ç•³ã‚“ã ã¨ãã‚‚è·é›¢ãŒé•·ã„å ´åˆãŒã‚ã‚‹ã€‚
                // ãªã®ã§ã€Œå°æŒ‡ã®ä»˜ã‘æ ¹(17)ã€ã‹ã‚‰ã®è·é›¢ã‚‚åŠ å‘³ã™ã‚‹ã€‚
                const pinkyBase = landmarks[17];
                const thumbTipToPinky = Math.hypot(tip.x - pinkyBase.x, tip.y - pinkyBase.y);
                const indexBaseToPinky = Math.hypot(landmarks[5].x - pinkyBase.x, landmarks[5].y - pinkyBase.y);
                
                // æ¡ä»¶A: æ‰‹é¦–ã‹ã‚‰é ã„
                // æ¡ä»¶B: å°æŒ‡ã®ä»˜ã‘æ ¹ã‹ã‚‰ã€äººå·®ã—æŒ‡ã®ä»˜ã‘æ ¹ä»¥ä¸Šã«é ã„ (é–‹ã„ã¦ã„ã‚‹)
                const condA = distTip > distPip * 1.05; // å°‘ã—ç·©ã‚
                const condB = thumbTipToPinky > indexBaseToPinky * 0.9; // ã‹ãªã‚Šç·©ã‚

                extended[0] = condA && condB;

            } else {
                // ã€ä»–ã®4æœ¬ã€‘
                // æŒ‡å…ˆãŒã€é–¢ç¯€ã‚ˆã‚Šã‚‚æ‰‹é¦–ã‹ã‚‰é ã‘ã‚Œã°ã€Œä¼¸ã³ã¦ã„ã‚‹ã€ã¨ã¿ãªã™
                // å€ç‡ 1.0 ã ã¨å³å¯†ã™ãã‚‹ã®ã§ã€0.9ãã‚‰ã„ã«ã—ã¦ã€Œã¡ã‚‡ã£ã¨æ›²ãŒã£ã¦ã¦ã‚‚OKã€ã«ã™ã‚‹
                extended[i] = distTip > (distPip * 1.1); // å°‘ã—å³ã—ã‚ã«ã—ã¦èª¤æ¤œçŸ¥é˜²ã? ã„ã‚„ã€æ„Ÿåº¦ã‚ˆãã™ã‚‹ãªã‚‰å€¤ã‚’ä¸‹ã’ã‚‹
                // æ„Ÿåº¦ãŒæ‚ªã„ï¼ä¼¸ã³ã¦ã‚‹ã¨åˆ¤å®šã•ã‚Œãªã„ã€‚å€¤ã‚’ä¸‹ã’ã‚Œã°åˆ¤å®šã•ã‚Œã‚„ã™ããªã‚‹ã€‚
                // ä»Šå›ã¯ 1.0 ã«ã—ã¦ã¿ã‚‹ï¼ˆPIPã‚ˆã‚Šé ã‘ã‚Œã°å³OKï¼‰
                 extended[i] = distTip > distPip;
            }
        }
        return extended;
    }

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: 1280, height: 720 } 
            });
            videoElement.srcObject = stream;
            videoElement.play();
            videoElement.onloadedmetadata = () => {
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                processVideo();
            };
        } catch (err) { alert("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: " + err.name); }
    }

    async function processVideo() {
        await hands.send({image: videoElement});
        requestAnimationFrame(processVideo);
    }
</script>
</body>
</html>
